From 9f43f9c7c9d51ea8e7fe2dce14985aaa1d748aae Mon Sep 17 00:00:00 2001
From: Kent Russell <kent.russell@amd.com>
Date: Wed, 9 Aug 2017 08:42:39 -0400
Subject: [PATCH 1776/4131] drm/amdkfd: Fix vram_usage being removed

Change-Id: I0ebc4c958b7fd1253cfd1cf4706925add69611b8
---
 drivers/gpu/drm/amd/amdgpu/amdgpu_amdkfd.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_amdkfd.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_amdkfd.c
index f022cec..5d09ad3 100755
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_amdkfd.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_amdkfd.c
@@ -482,7 +482,8 @@ int amdgpu_amdkfd_get_dmabuf_info(struct kgd_dev *kgd, int dma_buf_fd,
 uint64_t amdgpu_amdkfd_get_vram_usage(struct kgd_dev *kgd)
 {
 	struct amdgpu_device *adev = (struct amdgpu_device *)kgd;
-	uint64_t usage = (u64)atomic64_read(&adev->vram_usage);
+	uint64_t usage =
+		amdgpu_vram_mgr_usage(&adev->mman.bdev.man[TTM_PL_VRAM]);
 	return usage;
 }
 
-- 
2.7.4

