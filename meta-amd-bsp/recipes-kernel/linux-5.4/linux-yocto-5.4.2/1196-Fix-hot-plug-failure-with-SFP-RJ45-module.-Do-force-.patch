From c97d19a1a64209bcfc996165dd9a15b42ab59fc9 Mon Sep 17 00:00:00 2001
From: Sudheer Anumolu <sudheer.anumolu@amd.com>
Date: Tue, 26 Nov 2019 18:37:56 +0530
Subject: [PATCH 1196/1453] Fix hot plug failure with SFP+RJ45 module. Do force
 MDIO only if an external phy is available.

Signed-off-by: Sudheesh Mavila <sudheesh.mavila@amd.com>
---
 drivers/net/ethernet/amd/xgbe/xgbe-phy-v2.c | 11 +++++++----
 drivers/net/phy/marvell10g.c                |  1 -
 2 files changed, 7 insertions(+), 5 deletions(-)

diff --git a/drivers/net/ethernet/amd/xgbe/xgbe-phy-v2.c b/drivers/net/ethernet/amd/xgbe/xgbe-phy-v2.c
index 745f534908c3..585d14962268 100755
--- a/drivers/net/ethernet/amd/xgbe/xgbe-phy-v2.c
+++ b/drivers/net/ethernet/amd/xgbe/xgbe-phy-v2.c
@@ -1002,6 +1002,13 @@ static int xgbe_phy_find_phy_device(struct xgbe_prv_data *pdata)
 	/* Clear the extra AN flag */
 	pdata->an_again = 0;
 
+	/* For SFP, only use an external PHY if available */
+	if (phy_data->port_mode == XGBE_PORT_MODE_SFP) {
+		force_mdio_mv_bp_con = 0;
+	    	if(!phy_data->sfp_phy_avail)
+			return 0;
+	}
+
 	/* Check for the use of an external PHY */
 	if (phy_data->phydev_mode == XGBE_MDIO_MODE_NONE) {
 		if(force_mdio_mv_bp_con) {
@@ -1013,10 +1020,6 @@ static int xgbe_phy_find_phy_device(struct xgbe_prv_data *pdata)
 		}
 	}
 
-	/* For SFP, only use an external PHY if available */
-	if ((phy_data->port_mode == XGBE_PORT_MODE_SFP) &&
-	    !phy_data->sfp_phy_avail)
-		return 0;
 
 	/* Set the proper MDIO mode for the PHY */
 	ret = pdata->hw_if.set_ext_mii_mode(pdata, phy_data->mdio_addr,
diff --git a/drivers/net/phy/marvell10g.c b/drivers/net/phy/marvell10g.c
index b986195988d1..443cda8adc2d 100755
--- a/drivers/net/phy/marvell10g.c
+++ b/drivers/net/phy/marvell10g.c
@@ -59,7 +59,6 @@ enum {
 	MV_V2_TEMP_CTRL_SAMPLE	= 0x0000,
 	MV_V2_TEMP_CTRL_DISABLE	= 0xc000,
 	MV_V2_MODE_CFG		= 0xf000,
-	MV_V2_PORT_CTRL		= 0xf001,
 	MV_V2_LED0_CTRL		= 0xf020,
 	MV_V2_TEMP		= 0xf08c,
 	MV_V2_HOST_KR_ENABLE    = 0xf084,
-- 
2.17.1

