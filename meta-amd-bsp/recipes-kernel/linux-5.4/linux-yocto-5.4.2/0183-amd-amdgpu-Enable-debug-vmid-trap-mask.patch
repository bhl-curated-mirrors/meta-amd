From 98d1c5b1ffc7d79013b9dada9914efa625e086a7 Mon Sep 17 00:00:00 2001
From: Philip Cox <Philip.Cox@amd.com>
Date: Tue, 16 Jul 2019 09:39:44 -0400
Subject: [PATCH 0183/1453] amd/amdgpu: Enable debug vmid trap mask

To always have wave state info available for the debugger, we enable
the debug trap mask always for vg10 asics.

Change-Id: Ic8d50c39ecbc70b031f8c199c1bcae78674a4edf
Signed-off-by: Philip Cox <Philip.Cox@amd.com>
Signed-off-by: Flora Cui <flora.cui@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/amdgpu/gfx_v9_0.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/drivers/gpu/drm/amd/amdgpu/gfx_v9_0.c b/drivers/gpu/drm/amd/amdgpu/gfx_v9_0.c
index 50852ed4cc65..2867b57341c2 100644
--- a/drivers/gpu/drm/amd/amdgpu/gfx_v9_0.c
+++ b/drivers/gpu/drm/amd/amdgpu/gfx_v9_0.c
@@ -2450,6 +2450,8 @@ static void gfx_v9_0_init_compute_vmid(struct amdgpu_device *adev)
 	int i;
 	uint32_t sh_mem_config;
 	uint32_t sh_mem_bases;
+	uint32_t trap_config_vmid_mask = 0;
+	uint32_t data;
 
 	/*
 	 * Configure apertures:
@@ -2469,10 +2471,20 @@ static void gfx_v9_0_init_compute_vmid(struct amdgpu_device *adev)
 		/* CP and shaders */
 		WREG32_SOC15_RLC(GC, 0, mmSH_MEM_CONFIG, sh_mem_config);
 		WREG32_SOC15_RLC(GC, 0, mmSH_MEM_BASES, sh_mem_bases);
+
+		/* Calculate trap config vmid mask */
+		trap_config_vmid_mask |= (1 << i);
 	}
 	soc15_grbm_select(adev, 0, 0, 0, 0);
 	mutex_unlock(&adev->srbm_mutex);
 
+	data = 0;
+	data = REG_SET_FIELD(data, SPI_GDBG_TRAP_CONFIG,
+			VMID_SEL, trap_config_vmid_mask);
+	data = REG_SET_FIELD(data, SPI_GDBG_TRAP_CONFIG,
+			TRAP_EN, 1);
+	WREG32(SOC15_REG_OFFSET(GC, 0, mmSPI_GDBG_TRAP_CONFIG), data);
+
 	/* Initialize all compute VMIDs to have no GDS, GWS, or OA
 	   acccess. These should be enabled by FW for target VMIDs. */
 	for (i = FIRST_COMPUTE_VMID; i < LAST_COMPUTE_VMID; i++) {
-- 
2.17.1

