From 84dd0558b395698b7a005725892d5ec88d69f299 Mon Sep 17 00:00:00 2001
From: Oak Zeng <Oak.Zeng@amd.com>
Date: Tue, 9 Jul 2019 09:40:15 -0500
Subject: [PATCH 3102/4256] drm/amdkfd: Fix sdma_bitmap overflow issue

In the original formula, when sdma queue number is 64,
the left shift overflows. Use an equivalence that won't
overflow.

Change-Id: Ibf55a1bcaee32a098147ac76a7a11ac5808d2c75
Signed-off-by: Oak Zeng <Oak.Zeng@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
---
 drivers/gpu/drm/amd/amdkfd/kfd_device_queue_manager.c | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/drivers/gpu/drm/amd/amdkfd/kfd_device_queue_manager.c b/drivers/gpu/drm/amd/amdkfd/kfd_device_queue_manager.c
index 471519f5f3f2..d8418e6bec86 100644
--- a/drivers/gpu/drm/amd/amdkfd/kfd_device_queue_manager.c
+++ b/drivers/gpu/drm/amd/amdkfd/kfd_device_queue_manager.c
@@ -962,8 +962,8 @@ static int initialize_nocpsch(struct device_queue_manager *dqm)
   }
 
   dqm->vmid_bitmap = (1 << dqm->dev->vm_info.vmid_num_kfd) - 1;
-  dqm->sdma_bitmap = (1ULL << get_num_sdma_queues(dqm)) - 1;
-  dqm->xgmi_sdma_bitmap = (1ULL << get_num_xgmi_sdma_queues(dqm)) - 1;
+  dqm->sdma_bitmap = ~0ULL >> (64 - get_num_sdma_queues(dqm));
+  dqm->xgmi_sdma_bitmap = ~0ULL >> (64 - get_num_xgmi_sdma_queues(dqm));
 
   return 0;
 }
@@ -1101,8 +1101,8 @@ static int initialize_cpsch(struct device_queue_manager *dqm)
   dqm->sdma_queue_count = 0;
   dqm->xgmi_sdma_queue_count = 0;
   dqm->active_runlist = false;
-  dqm->sdma_bitmap = (1ULL << get_num_sdma_queues(dqm)) - 1;
-  dqm->xgmi_sdma_bitmap = (1ULL << get_num_xgmi_sdma_queues(dqm)) - 1;
+  dqm->sdma_bitmap = ~0ULL >> (64 - get_num_sdma_queues(dqm));
+  dqm->xgmi_sdma_bitmap = ~0ULL >> (64 - get_num_xgmi_sdma_queues(dqm));
   dqm->trap_debug_vmid = 0;
 
   INIT_WORK(&dqm->hw_exception_work, kfd_process_hw_exception);
-- 
2.17.1

