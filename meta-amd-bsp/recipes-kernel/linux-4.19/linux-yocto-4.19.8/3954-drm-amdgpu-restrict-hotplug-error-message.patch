From ed1735eaaadc754a8b233a98b0af77dbeebeceb0 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Christian=20K=C3=B6nig?= <ckoenig.leichtzumerken@gmail.com>
Date: Thu, 19 Sep 2019 15:16:49 +0200
Subject: [PATCH 3954/4256] drm/amdgpu: restrict hotplug error message
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

We should print the error only when we are hotplugged and crash
basically all userspace applications.

Signed-off-by: Christian König <ckoenig.leichtzumerken@gmail.com>
Signed-off-by: Christian König <christian.koenig@amd.com>
Reviewed-by: Emily Deng <Emily.Deng@amd.com>
Acked-by: Alex Deucher <alexander.deucher@amd.com>
---
 drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c     |  8 ++++--
 drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c.rej | 30 ---------------------
 2 files changed, 6 insertions(+), 32 deletions(-)
 delete mode 100644 drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c.rej

diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c
index 9f7118ab1e93..82b20de92591 100644
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c
@@ -1101,9 +1101,13 @@ static void
 amdgpu_pci_remove(struct pci_dev *pdev)
 {
 	struct drm_device *dev = pci_get_drvdata(pdev);
-	
-	DRM_ERROR("Device removal is currently not supported outside of fbcon\n");
+
+#ifdef MODULE
+        if (THIS_MODULE->state != MODULE_STATE_GOING)
+#endif
+	        DRM_ERROR("Hotplug removal is not supported\n");	
 	drm_dev_unplug(dev);
+	drm_dev_put(dev);
 	pci_disable_device(pdev);
 	pci_set_drvdata(pdev, NULL);
 }
diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c.rej b/drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c.rej
deleted file mode 100644
index 98377b949f17..000000000000
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c.rej
+++ /dev/null
@@ -1,30 +0,0 @@
---- drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c
-+++ drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c
-@@ -527,22 +527,21 @@ module_param_named(gpu_recovery, amdgpu_gpu_recovery, int, 0444);
- MODULE_PARM_DESC(emu_mode, "Emulation mode, (1 = enable, 0 = disable)");
- module_param_named(emu_mode, amdgpu_emu_mode, int, 0444);
- 
--/*
-- * DOC: amdgpu_ras_enable (int)
-+/**
-+ * DOC: ras_enable (int)
-  * Enable RAS features on the GPU (0 = disable, 1 = enable, -1 = auto (default))
-  */
--MODULE_PARM_DESC(amdgpu_ras_enable, "Enable RAS features on the GPU (0 = disable, 1 = enable, -1 = auto (default))");
-+MODULE_PARM_DESC(ras_enable, "Enable RAS features on the GPU (0 = disable, 1 = enable, -1 = auto (default))");
- module_param_named(ras_enable, amdgpu_ras_enable, int, 0444);
- 
- /**
-- * DOC: amdgpu_ras_mask (uint)
-+ * DOC: ras_mask (uint)
-  * Mask of RAS features to enable (default 0xffffffff), only valid when ras_enable == 1
-  * See the flags in drivers/gpu/drm/amd/amdgpu/amdgpu_ras.h
-  */
--MODULE_PARM_DESC(amdgpu_ras_mask, "Mask of RAS features to enable (default 0xffffffff), only valid when ras_enable == 1");
-+MODULE_PARM_DESC(ras_mask, "Mask of RAS features to enable (default 0xffffffff), only valid when ras_enable == 1");
- module_param_named(ras_mask, amdgpu_ras_mask, uint, 0444);
- 
--
- /**
-  * DOC: si_support (int)
-  * Set SI support driver. This parameter works after set config CONFIG_DRM_AMDGPU_SI. For SI asic, when radeon driver is enabled,
-- 
2.17.1

