From 9e6d9576a749f83d521a6d63cbaf5367d54745ce Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Christian=20K=C3=B6nig?= <christian.koenig@amd.com>
Date: Tue, 7 Aug 2018 14:52:13 +0200
Subject: [PATCH 0702/2940] drm/scheduler: fix last_scheduled handling
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Make sure we access last_scheduled only after checking that there are no
more jobs on the entity.

Signed-off-by: Christian KÃ¶nig <christian.koenig@amd.com>
Reviewed-by: Nayan Deshmukh <nayan26deshmukh@gmail.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
---
 drivers/gpu/drm/scheduler/gpu_scheduler.c | 21 +++++++++++----------
 1 file changed, 11 insertions(+), 10 deletions(-)

diff --git a/drivers/gpu/drm/scheduler/gpu_scheduler.c b/drivers/gpu/drm/scheduler/gpu_scheduler.c
index 41c277bdea82..4fa54f4e1d78 100644
--- a/drivers/gpu/drm/scheduler/gpu_scheduler.c
+++ b/drivers/gpu/drm/scheduler/gpu_scheduler.c
@@ -600,19 +600,20 @@ void drm_sched_entity_push_job(struct drm_sched_job *sched_job,
 			       struct drm_sched_entity *entity)
 {
 	struct drm_sched_rq *rq = entity->rq;
-	bool first, reschedule, idle;
+	bool first;
 
-	idle = entity->last_scheduled == NULL ||
-		dma_fence_is_signaled(entity->last_scheduled);
 	first = spsc_queue_count(&entity->job_queue) == 0;
-	reschedule = idle && first && (entity->num_rq_list > 1);
+	if (first && (entity->num_rq_list > 1)) {
+		struct dma_fence *fence;
 
-	if (reschedule) {
-		rq = drm_sched_entity_get_free_sched(entity);
-		spin_lock(&entity->rq_lock);
-		drm_sched_rq_remove_entity(entity->rq, entity);
-		entity->rq = rq;
-		spin_unlock(&entity->rq_lock);
+		fence = READ_ONCE(entity->last_scheduled);
+		if (fence == NULL || dma_fence_is_signaled(fence)) {
+			rq = drm_sched_entity_get_free_sched(entity);
+			spin_lock(&entity->rq_lock);
+			drm_sched_rq_remove_entity(entity->rq, entity);
+			entity->rq = rq;
+			spin_unlock(&entity->rq_lock);
+		}
 	}
 
 	sched_job->sched = entity->rq->sched;
-- 
2.17.1

