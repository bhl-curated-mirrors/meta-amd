From 6da582186f8551f9974719c05532dced9c59c5f7 Mon Sep 17 00:00:00 2001
From: Chaudhary Amit Kumar <chaudharyamit.kumar@amd.com>
Date: Wed, 17 Oct 2018 16:33:15 +0530
Subject: [PATCH 0775/4131] drm/amdgpu: unbind gart when release direct gma
 imported bo

Change-Id: Ie8db112202ad2b11a5ec1294dc9b4163eaa0a542
Signed-off-by: Flora Cui <Flora.Cui@amd.com>
Reviewed-by: Hawking Zhang <Hawking.Zhang@amd.com>

Signed-off-by: Chaudhary Amit Kumar <chaudharyamit.kumar@amd.com>
---
 drivers/gpu/drm/amd/amdgpu/amdgpu_object.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_object.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_object.c
index 4a57461..1cee845 100644
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_object.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_object.c
@@ -41,9 +41,15 @@ static void amdgpu_ttm_bo_destroy(struct ttm_buffer_object *tbo)
 {
 	struct amdgpu_device *adev = amdgpu_ttm_adev(tbo->bdev);
 	struct amdgpu_bo *bo;
+	u64 offset;
 
 	bo = container_of(tbo, struct amdgpu_bo, tbo);
 
+	if (bo->tbo.mem.mem_type == AMDGPU_PL_DGMA_IMPORT) {
+		offset = amdgpu_bo_gpu_offset(bo);
+		offset -= adev->mman.bdev.man[TTM_PL_TT].gpu_offset;
+		amdgpu_gart_unbind(adev, offset, bo->tbo.num_pages);
+	}
 	amdgpu_bo_kunmap(bo);
 
 	if (bo->gem_base.import_attach)
-- 
2.7.4

